stages:
  - build
  - test
  - deploy

# âœ… BACKEND BUILD (PHP + MongoDB)
build_app:
  stage: build
  image: php:8.2
  before_script:
    - apt-get update && apt-get install -y unzip git curl libzip-dev zlib1g-dev
    - pecl install mongodb-1.19.1
    - echo "extension=mongodb.so" > /usr/local/etc/php/conf.d/mongodb.ini
    - curl -sS https://getcomposer.org/installer | php
    - mv composer.phar /usr/local/bin/composer
  script:
    - echo "ğŸ“¦ Installing PHP dependencies"
    - cd backend
    - composer install --ignore-platform-req=ext-mongodb
    - cd ..
    - echo "âœ… Build complete"
  only:
    - main



# âœ… FRONTEND BUILD (React + Node)
build_frontend:
  stage: build
  image: node:18
  script:
    - echo "âš›ï¸ Building React frontend"
    - cd client
    - npm install
    - npm run build
    - cd ..
    - rm -rf public             # ğŸ’¥ Remove if exists
    - mv client/build public    # âœ… Move to public/
  only:
    - main


# âœ… TEST STAGE (optional)
test_app:
  stage: test
  script:
    - echo "âœ… No tests yet"
  only:
    - main

# âœ… DEPLOY STAGE (optional)
deploy_app:
  stage: deploy
  script:
    - echo "ğŸš€ Deployment script goes here"
  only:
    - tags
pages:
  stage: deploy
  script:
    - echo "Deploying to GitLab Pages"
  artifacts:
    paths:
      - public   # ğŸ‘ˆ The directory with your built site
  only:
    - main

